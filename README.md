# 玄学AI智能体 🔮

基于传统命理学与现代AI技术的智能预测系统，集成缘分居国学API和DeepSeek大语言模型，为用户提供专业的八字命理分析和人生指导。采用Streamlit构建现代化Web界面，支持分级下拉框选择、多种预测类型和个性化分析。

## 🌟 项目特色

- **专业八字分析**：集成缘分居国学API，提供准确的四柱八字计算、十神关系和格局分析
- **AI智能预测**：使用DeepSeek大语言模型，支持多LLM提供商，生成个性化的命理解读
- **多维度分析**：支持综合运势、事业发展、感情婚姻、商业运势等四种专业预测类型
- **现代化界面**：基于Streamlit构建的响应式Web界面，支持省市联动选择和美观的UI设计
- **智能交互**：分级下拉框选择出生地，实时表单验证，历史记录管理和结果导出分享
- **数据安全**：完善的数据验证和隐私保护，用户数据不持久化存储，严格的安全检查

## 🚀 快速开始

### 环境要求

- Python 3.8+
- 稳定的网络连接（用于API调用）

### 安装依赖

```bash
pip install -r requirements.txt
```

### 配置环境变量

1. 复制环境变量模板：
```bash
cp .env.example .env
```

2. 编辑 `.env` 文件，填入您的API密钥：
```env
# DeepSeek API配置
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_API_BASE=https://api.deepseek.com
DEEPSEEK_MODEL_NAME=deepseek-chat

# 缘分居国学API配置
YUANFENJU_API_KEY=your_yuanfenju_api_key_here
YUANFENJU_API_URL=https://api.yuanfenju.com

# LLM配置
LLM_PROVIDER=chatdeepseek  # 支持 chatdeepseek 或 chatopenai
LLM_TEMPERATURE=0.7
LLM_MAX_TOKENS=2000
LLM_TOP_P=0.9

# 系统提示词配置（可自定义）
SYSTEM_PROMPT_COMPREHENSIVE="你是一位专业的命理学大师..."
SYSTEM_PROMPT_CAREER="你是一位专业的职业规划师..."
SYSTEM_PROMPT_RELATIONSHIP="你是一位专业的情感咨询师..."

# 系统配置
DEBUG=false
LOG_LEVEL=INFO
```

### 启动应用

```bash
streamlit run app.py
```

应用将在 `http://localhost:8501` 启动。

## 📁 项目结构

```
aibz/
├── app.py                 # Streamlit主应用文件
├── api_client.py          # 缘分居国学API客户端
├── run.py                 # 应用启动脚本
├── test_app.py            # 应用测试文件
├── province.json          # 省市数据文件（支持分级选择）
├── requirements.txt       # 项目依赖包列表
├── .env.example          # 环境变量配置模板
├── .gitignore            # Git忽略文件配置
├── LICENSE               # 项目开源许可证
├── README.md             # 项目使用说明文档
├── requirements_document.md # 项目需求文档
├── design_document.md    # 项目设计文档
├── project_execution_plan.md # 项目执行计划
├── config/               # 配置管理模块
│   ├── __init__.py
│   ├── settings.py       # 系统配置和环境变量管理
│   └── prompts/          # 提示词模板配置
│       ├── comprehensive_prompt.txt # 综合运势分析提示词
│       ├── career_prompt.txt        # 事业发展分析提示词
│       ├── relationship_prompt.txt  # 感情婚姻分析提示词
│       └── business_prompt.txt      # 商业运势分析提示词
├── services/             # 业务服务层
│   ├── __init__.py
│   ├── bazi_service.py   # 八字数据服务（API调用和数据处理）
│   └── prediction_service.py # 预测服务（AI模型调用和结果处理）
├── models/               # 数据模型层
│   ├── __init__.py
│   ├── user_info.py      # 用户信息数据模型
│   ├── bazi_data.py      # 八字数据模型
│   └── prediction_result.py # 预测结果模型
├── utils/                # 工具模块
│   ├── __init__.py
│   ├── data_validator.py # 数据验证和安全检查工具
│   └── logger.py         # 统一日志记录工具
├── logs/                 # 日志文件存储目录
├── .vercel/              # Vercel部署配置
│   └── project.json
└── 八字分析系统*.docx    # 项目相关文档
```

## ⚙️ 配置说明

### LLM提供商配置

系统支持多种大语言模型提供商，可通过环境变量进行配置：

- **chatdeepseek**：使用DeepSeek API（推荐）
- **chatopenai**：使用OpenAI兼容的API

### LLM参数配置

- `LLM_TEMPERATURE`：控制输出的随机性（0.0-1.0）
- `LLM_MAX_TOKENS`：最大输出token数量
- `LLM_TOP_P`：核采样参数（0.0-1.0）

### 系统提示词自定义

支持自定义三种预测类型的系统提示词：

- `SYSTEM_PROMPT_COMPREHENSIVE`：综合运势分析提示词
- `SYSTEM_PROMPT_CAREER`：事业发展分析提示词
- `SYSTEM_PROMPT_RELATIONSHIP`：感情婚姻分析提示词

提示词支持多行文本，使用`\n`表示换行。

## 🔧 功能模块

### 1. 用户信息管理
- **基本信息收集**：姓名、性别输入和验证
- **出生时间管理**：年、月、日、时、分的精确输入（支持1900年至当前年份）
- **出生地点选择**：省市分级下拉框联动选择，基于province.json数据
- **咨询问题**：可选的具体咨询内容输入
- **数据验证**：实时表单验证和数据安全检查

### 2. 八字分析服务
- **API集成**：调用缘分居国学API获取专业八字数据
- **四柱八字**：年柱、月柱、日柱、时柱的完整计算
- **五行分析**：金木水火土五行强弱分析
- **十神关系**：十神关系和格局分析
- **大运流年**：大运和流年信息计算
- **用神喜忌**：用神分析和喜忌神判断

### 3. AI预测服务
- **多LLM支持**：支持DeepSeek、OpenAI等多种大语言模型提供商
- **预测类型**：综合运势、事业发展、感情婚姻、商业运势四种专业分析
- **提示词配置**：可配置的专业提示词模板，针对不同预测类型优化
- **模型参数**：可调节的温度、最大token数、top_p等参数
- **个性化分析**：基于八字数据和用户问题的定制化预测
- **专业建议**：积极正面的人生指导和建议

### 4. Web界面与交互
- **现代化设计**：基于Streamlit的响应式Web界面，支持桌面和移动设备
- **分级选择**：省市联动下拉框，实时响应用户操作
- **美观UI**：自定义CSS样式，渐变背景和现代化组件
- **状态管理**：会话级别的状态管理和数据持久化
- **加载提示**：清晰的加载状态和进度提示
- **错误处理**：友好的错误提示和异常处理

### 5. 历史记录与导出
- **历史管理**：会话级别的预测历史记录保存
- **记录查看**：预测记录摘要展示和完整报告查看
- **记录操作**：支持历史记录删除和重新查看
- **结果导出**：预测结果的完整报告导出功能
- **结果分享**：生成可分享的预测摘要

### 6. 系统监控与日志
- **服务状态**：实时API连接状态监控
- **系统信息**：版本信息和系统状态显示
- **日志记录**：详细的操作日志和错误日志
- **性能监控**：API调用时间和响应状态跟踪

## 🎯 使用指南

### 基本使用流程

#### 1. 填写个人信息
- **姓名输入**：在"姓名"字段输入您的真实姓名
- **性别选择**：从下拉框中选择"男"或"女"
- **出生时间**：
  - 年份：选择1900年至当前年份
  - 月份：选择1-12月
  - 日期：根据月份自动调整可选日期范围
  - 时辰：选择具体小时（0-23时）
  - 分钟：选择具体分钟（0-59分）
- **出生地点**：
  - 先选择省份/直辖市/自治区
  - 再选择具体城市（系统自动加载对应城市列表）
- **咨询问题**（可选）：输入您想要咨询的具体问题

#### 2. 选择预测类型
在侧边栏选择您需要的预测类型：
- **综合运势**：全面的人生运势分析
- **事业发展**：职业发展和事业运势
- **感情婚姻**：感情状况和婚姻运势
- **商业运势**：投资理财和商业机会

#### 3. 生成预测报告
- 点击"开始预测"按钮
- 系统将自动：
  1. 调用缘分居API获取八字数据
  2. 使用AI模型生成个性化预测
  3. 展示完整的分析报告
- 预测过程中会显示加载状态

#### 4. 查看和管理结果
- **查看报告**：在主界面查看完整的预测报告
- **历史记录**：在侧边栏查看之前的预测记录
- **重新查看**：点击历史记录可重新查看之前的预测
- **删除记录**：可删除不需要的历史记录

### 高级功能

#### 配置管理
- **LLM提供商切换**：通过环境变量配置不同的AI模型提供商
- **模型参数调整**：调节温度、最大token数等参数
- **提示词自定义**：修改config/prompts/目录下的提示词文件

#### 系统监控
- **服务状态**：实时查看API连接状态
- **系统信息**：查看应用版本和运行状态
- **日志查看**：通过logs目录查看详细日志

#### 数据导出
- **结果保存**：预测结果自动保存在会话中
- **报告分享**：可复制预测结果进行分享
- **历史管理**：支持批量管理历史预测记录

## 🛡️ 安全特性

### 数据安全
- **传输加密**：所有API调用使用HTTPS加密传输
- **隐私保护**：用户数据仅在会话期间保存，不进行永久存储
- **敏感信息处理**：API密钥等敏感配置通过环境变量管理
- **数据验证**：严格的用户输入验证和数据格式检查

### API安全
- **安全调用**：使用官方API接口，遵循最佳安全实践
- **错误处理**：完善的异常处理机制，避免敏感信息泄露
- **访问控制**：API密钥权限控制和访问频率限制
- **日志安全**：敏感信息不记录在日志文件中

### 系统安全
- **输入过滤**：防止恶意输入和注入攻击
- **会话管理**：安全的会话状态管理
- **依赖安全**：定期更新依赖包，修复安全漏洞

## 📊 系统监控

### 实时状态监控
- **API连接状态**：实时检查缘分居API和AI服务连接
- **服务可用性**：监控各个服务组件的运行状态
- **响应时间**：跟踪API调用和页面加载时间
- **错误率统计**：监控系统错误发生频率

### 系统信息展示
- **应用版本**：当前运行的应用版本信息
- **运行状态**：系统运行时间和资源使用情况
- **配置信息**：当前LLM提供商和模型配置
- **环境状态**：Python版本和依赖包状态

## 📝 日志与监控

### 日志系统
- **分级日志**：支持DEBUG、INFO、WARNING、ERROR等不同级别
- **文件存储**：日志文件保存在`logs/`目录，按日期自动分割
- **格式化输出**：结构化的日志格式，便于分析和调试
- **自动清理**：定期清理过期日志文件，节省存储空间

### 性能监控
- **API性能**：记录每次API调用的响应时间和状态
- **用户行为**：跟踪用户操作流程和使用模式
- **系统资源**：监控内存使用和CPU占用情况
- **错误追踪**：详细记录错误堆栈和上下文信息

## 🔧 故障排除

### 常见问题解决

#### 1. API连接问题
**症状**：无法获取八字数据或AI预测失败
**解决方案**：
- 检查网络连接是否正常
- 验证`.env`文件中的API密钥配置
- 查看`logs/`目录下的错误日志
- 确认API服务商的服务状态

#### 2. 环境配置问题
**症状**：应用启动失败或功能异常
**解决方案**：
```bash
# 检查Python版本（需要3.8+）
python --version

# 重新安装依赖
pip install -r requirements.txt

# 检查环境变量配置
cat .env
```

#### 3. 界面显示问题
**症状**：页面布局异常或功能按钮无响应
**解决方案**：
- 清除浏览器缓存和Cookie
- 尝试使用无痕模式访问
- 检查浏览器控制台的JavaScript错误
- 重启Streamlit应用

#### 4. 预测结果异常
**症状**：预测内容不完整或格式错误
**解决方案**：
- 检查LLM模型的token限制设置
- 验证提示词模板格式
- 确认输入数据的完整性
- 查看AI服务的响应日志